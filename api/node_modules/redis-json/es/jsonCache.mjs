/*! *****************************************************************************
Copyright (c) Microsoft Corporation. All rights reserved.
Licensed under the Apache License, Version 2.0 (the "License"); you may not use
this file except in compliance with the License. You may obtain a copy of the
License at http://www.apache.org/licenses/LICENSE-2.0

THIS CODE IS PROVIDED ON AN *AS IS* BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY
KIND, EITHER EXPRESS OR IMPLIED, INCLUDING WITHOUT LIMITATION ANY IMPLIED
WARRANTIES OR CONDITIONS OF TITLE, FITNESS FOR A PARTICULAR PURPOSE,
MERCHANTABLITY OR NON-INFRINGEMENT.

See the Apache Version 2.0 License for specific language governing permissions
and limitations under the License.
***************************************************************************** */
function e(e,t,i,n){return new(i||(i=Promise))((function(r,s){function o(e){try{c(n.next(e))}catch(e){s(e)}}function l(e){try{c(n.throw(e))}catch(e){s(e)}}function c(e){e.done?r(e.value):new i((function(t){t(e.value)})).then(o,l)}c((n=n.apply(e,t||[])).next())}))}const t={undefined:!0,null:!0,false:!0,true:!0};function i(e,n="",r={}){return Object.entries(e).forEach(([e,s])=>{const o=function(e){return e.replace(/\./g,"/.")}(e);!function e(n,r,s){const o=Array.isArray(n);n instanceof Object&&!o?0===Object.keys(n).length?s[r]="{}":i(n,r,s):o?0===n.length?s[r]="[]":n.forEach((t,i)=>{e(t,`${r}.${i}`,s)}):s[r]=t[n]?n+"":n}(s,n?`${n}.${o}`:o,r)}),r}const n={"{}":()=>({}),"[]":()=>[],undefined:()=>void 0,null:()=>null,true:()=>!0,false:()=>!1};function r(e){const t=Number(e);return isNaN(t)?function(e){return e?e.replace(/\/./g,"."):e}(e):t}export default class{constructor(e,t={}){this.redisClient=e,this.options=t,this.options.prefix=t.prefix||"jc:"}set(t,n,r={}){return e(this,void 0,void 0,(function*(){const e=i(n);e.__jc_root__="0",yield this.redisClient.hmset.call(this.redisClient,this.getKey(t),e),r.expire&&(yield this.redisClient.expire.call(this.redisClient,this.getKey(t),r.expire))}))}get(t,...i){return e(this,void 0,void 0,(function*(){const e=yield this.redisClient[i.length>0?"hmget":"hgetall"].call(this.redisClient,this.getKey(t),...i);if(0!==Object.keys(e).length)return delete e.__jc_root__,i.length>0?i.reduce((t,i,n)=>(t[i]=e[n],t),{}):function(e){const t={};return Object.entries(e).forEach(([e,i])=>{const s=function(e){return e.split(/(?<!\/)\./)}(e);let o=0,l=r(s[o]),c=r(s[o+1]),u=t;for(;void 0!==c;){u[l]instanceof Object||(u[l]="number"==typeof c?[]:{}),u=u[l],++o<s.length&&(l=r(s[o]),c=r(s[o+1]))}u[l]=n[i]?n[i]():i}),t}(e)}))}rewrite(t,i){return e(this,void 0,void 0,(function*(){yield this.redisClient.del.call(this.redisClient,this.getKey(t)),yield this.set(t,i)}))}clearAll(){return e(this,void 0,void 0,(function*(){const e=yield this.redisClient.keys.call(this.redisClient,`${this.options.prefix}*`);yield this.redisClient.multi(e.map(e=>["del",e])).exec()}))}getKey(e){return`${this.options.prefix}${e}`}}
